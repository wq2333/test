<head>
	<script type="text/javascript" src="{{static_url('./lib/paper-full.min.js')}}"></script>
	<style type="text/css">
		.window1Div{
			position: absolute;background:#ff000042;width: 35%;height: 100%;top: 0;left: 0;
		}	
		.window2Div{
			position: absolute;background:black;width: 65%;height: 100%;top: 0;left: 35%;float: right;
		}
	</style>

	<script type="text/paperscript" canvas="canvas1">
	
		console.log(' here 0 ');

		g_liAttrName = ['gender']
		g_CurrentAttribteOptions = {}
		g_liFigure = [];
		g_CurrentShowFigureIndex = -1
		resetOptions();

		// Create a Paper.js Path to draw a line into it:
		var path = new Path();

		var canvasRect = document.getElementById('canvas1').getClientRects()[0]

		// Give the stroke a color
		var centerPos = {x: canvasRect.x + canvasRect.width * 0.5,
							y: canvasRect.y + canvasRect.height * 0.5}
		
	 	paper.project.importSVG("{{static_url('./svg/window1.svg')}}", 
        	function(item){
        		
        		g_Root = item;

        		var testItem = g_Root.children['test'];
        		testItem.onClick = function(){
        			// this.strokeColor = 'green'
        			// g_Root.children['ano'].visible = false;
        			// console.log(" test clicked ");
        		}
        		// console.log( 'test', );

        		initItems(item);
        		initEvent(item);

        })

	function resetOptions(){
		g_CurrentAttribteOptions = {}
		g_CurrentShowFigureIndex = -1
		for(var i = 0; i < g_liAttrName.length; i ++){
			g_CurrentAttribteOptions[g_liAttrName] = [];
		}
	}

	function updateOptions(dressBag, attrClicked){

		var attr = dressBag['attr']
		var option = dressBag['option']
		var index = g_CurrentAttribteOptions[attr].indexOf(option)
		if(attrClicked == true && index == -1){
			g_CurrentAttribteOptions[attr].push(option)
		}else if(attrClicked == false && index != -1){
			g_CurrentAttribteOptions[attr].splice(index, 1);
		}

		console.log(" g_CurrentAttribteOptionsg_CurrentAttribteOptions ", g_CurrentAttribteOptions);

		//update render
		var multiple = false
		// var liMultipleOptionAttribute = []
		var mapMAttriOptions = {}
		var liSingleOptionAttribute = []
		for(var i = 0; i < g_liAttrName.length; i ++){
			var attr = g_liAttrName[i]
			if(g_CurrentAttribteOptions[attr].length > 1){
				multiple = true
				mapMAttriOptions[attr] = g_CurrentAttribteOptions[attr]
			}else if(g_CurrentAttribteOptions[attr].length == 1){
				liSingleOptionAttribute.push(attr);
			}
		}		
		g_Root.getItem({'name': 'button_checkmore'}).visible = multiple;

		//create the Figure 
		for(var i = 0; i < g_liFigure.length; i ++){
			for(var j = 0; j < g_liFigure[i].length; j ++){
				g_liFigure[i][j].visible = false;
				g_liFigure[i][j].remove();
				// console.log(' remove ', g_liFigure);
			}
		}
		g_liFigure = []

		console.log(" SINGLE = ", liSingleOptionAttribute, ' MULTIPE = ', liMultipleOptionAttribute)

		var liFigureOptions = []
		var commonOption = [];

		// console.log(" liCommoptonp before ", commonOption_t, commonOption_t.length, commonOption_t[0], liFigureOptions_t);

		for(var i = 0; i < liSingleOptionAttribute.length; i ++){
			var singleAttr = liSingleOptionAttribute[i]
			var option = g_CurrentAttribteOptions[singleAttr];
			var dressOn = 'dresslater_' + option;
			console.log(" single ATTR ", singleAttr)
			commonOption.push(dressOn);
		}
		liFigureOptions.push(commonOption)

		// console.log(" liCommoptonp after ", commonOption_t, liFigureOptions);

		var liMultipleOptionAttribute = Object.keys(mapMAttriOptions);
		for(var i = 0; i < liMultipleOptionAttribute.length; i ++){
			var mAtrri = liMultipleOptionAttribute[i]
			var liOption = mapMAttriOptions[mAtrri]
			var liNewFigureOption = [];
			for(var j = 0; j < liOption.length; j ++){
				var option = liOption[j]
				console.log(' add M-option ', option)
				for(var p = 0; p < liFigureOptions.length; p ++){
					var option_temp = liFigureOptions[p];
					option_temp.push('dresslater_' + option);
					liNewFigureOption.push(option_temp);
				}
			}
			liFigureOptions = liNewFigureOption
		}

		console.log(' new figure options ', liFigureOptions);

		//render the figure, make the first one visible
		for(var i = 0; i < liFigureOptions.length; i ++){

			if(i >= 1)
				break;

			var figureOptions = liFigureOptions[i];

			var liChild = []
			console.log(' [1] ')
			var basePath = g_Root.children['suser_base'].clone()
			liChild.push(basePath)
			if(i == 0)
				basePath.visible = true;
			console.log(' [2] ')
			for(var j = 0; j < figureOptions.length; j ++){
				console.log(" [3] ", figureOptions[j])
				var temp = g_Root.children[figureOptions[j]].clone();
				temp.name = 'xx_' + i+ "_" + j
				if(i == 0)
					temp.visible = true;
				else
					temp.visible = false;
				liChild.push(temp)
			}
			g_liFigure.push(liChild);
		}
	}
	
	function initItems(item){
		//invisible dresslater
		var liDressLater = item.getItems({'name': /^dresslater/});
		for(var i = 0; i < liDressLater.length; i ++){
			var dressLater = liDressLater[i]
			dressLater.visible = false;
		}

		//invisible button_checkmore		
		item.getItem({'name': 'button_checkmore'}).visible = false;
	}

	function initEvent(item){

		for(var i = 0; i < g_liAttrName.length; i ++){
			var attrName = g_liAttrName[i];
			var childItem = item.children[attrName];
			var liOptionBar = childItem.getItems(
				{'name': /^attr/});
			for(var j = 0; j < liOptionBar.length; j ++){
				var optionBar = liOptionBar[j]
				optionBar.strokeWidth = 2
				optionBar._AttrClick = false
				optionBar.onClick = function(){
					this._AttrClick = !this._AttrClick;
					if(this._AttrClick){
						this.strokeColor = 'white';
					}else{						
						this.strokeColor = null;
					}
					changeOption(this._name, this._AttrClick)
				}
				optionBar.onMouseEnter = function(){
					this.strokeColor = 'white';
				}
				optionBar.onMouseLeave = function(){
					if(this._AttrClick == false)
						this.strokeColor = null;
				}
			}
		}
	}

	function changeOption(optionName, attrClicked){
		console.log(' change option ', optionName, attrClicked);
		var dressBag = getDressbag(optionName);
		//update the options
		updateOptions(dressBag, attrClicked);
		// if(attrClicked){
		// 	console.log(' Dress On ', liDressOn);
		// 	g_Root.children[liDressOn].visible = true;
		// }else{
		// 	console.log(' Dress Off ', liDressOn);
		// 	g_Root.children[liDressOn].visible = false;
		// }
	}

	function getDressbag(optionName){
		var attr = optionName.split('_')[1]
		var deSuffix = optionName.substr('attr_'.length, optionName.length - 'attr_'.length);
		return {
			'attr': attr,
			'option': deSuffix,
			'dresslater': 'dresslater_' + deSuffix
		}
	}

	</script>

</head>


<body>
	<div>
		<img src="{{static_url('./img/bg.png')}}" style="width:100%; height:100%"></img>
	</div>
	<div class='window1Div'>
		<!-- <img src="{{static_url('./img/fake.png')}}" style="width:100%; height:100%"></img> -->
		<canvas id="canvas1" style="
		    position: absolute;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    background: white;
		"></canvas>

	</div>
	<div class='window2Div'></div>

</body>

