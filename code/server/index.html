<head>

	<script type="text/javascript" src="{{static_url('./lib/paper-full.min.js')}}"></script>
	<script type="text/javascript" src="{{static_url('./lib/d3.min.js')}}"></script>
	<script type="text/javascript" src="{{static_url('./lib/Detector.js')}}"></script>
	<script type="text/javascript" src="{{static_url('./lib/jquery.min.js')}}"></script>
	<script type="text/javascript" src="{{static_url('./lib/lurlquery.js')}}"></script>
	<script type="text/javascript" src="{{static_url('./lib/three.min.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/OrbitControls.js')}}"></script>
	<script type="text/javascript" src="{{static_url('./lib/TrackballControls.js')}}"></script>

	<script type="text/javascript" src="{{static_url('./js/window1.js')}}"></script>
	<script type="text/javascript" src="{{static_url('./js/window3.js')}}"></script>

</head>


<body>
	<canvas id="canvas1" style="position: absolute;top: 0; left: 0; width: 35%;  height: 50%; background: black;"></canvas>
	<div id='window2' style="position: absolute; width: 35%;height: 50%;top: 50%;left: 0; background:black;"></div>
	<div id="window3" style="position: absolute;background:black; width: 65%;height: 100%;top: 0;left: 35%;float: right;"></div>


<script type="text/paperscript" canvas="canvas1">

		g_liAttrName = ['gender', 'age', 'income', 'edu', 'resident', 'car', 'house', 'job']
		g_CurrentAttribteOptions = {}
		g_liFigure = [];
		g_CurrentShowFigureIndex = -1
		currentGender = "1";
		resetOptions();

		// Create a Paper.js Path to draw a line into it:
		var path = new Path();
		var canvasRect = document.getElementById('canvas1').getClientRects()[0]

		// Give the stroke a color
		var centerPos = {x: canvasRect.x + canvasRect.width * 0.5,
							y: canvasRect.y + canvasRect.height * 0.5}

	 	paper.project.importSVG("{{static_url('./svg/window1.svg')}}",
        	function(item){
        		g_Root = item;
        		initItems(item);
        		initEvent(item);
        })

</script>
<script>

	var $d3g = {};
    d3threeD( $d3g );

    var renderer, scene, camera;

    var controls, stats, positionning, raycaster;
    var mouse = new THREE.Vector2();

    var numberjson, mapjson, clusterjson;


</script>


<script>
	var h = 600, w = 600;
    var svg = d3.select("#window2")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .append("g")
            .attr("transform", "translate(0,0)")
            .attr("id","svgWindow2");

var padding = 20;

var xScale, yScale;
var xAxis, yAxis;

var xScale = d3.scale.linear().domain([-80, 80]).range([padding*2, w - padding * 2]);
var yScale = d3.scale.linear().domain([-80, 80]).range([h - padding * 2, 2*padding ]);

var age = [1,2,3,4];  //1-4
var gender = [1,2]; //1-2
var edu = [1,2,3,4];  //1-4
var job = [1,2,3,4,5,6,7,8,9]; //1-9
var census = [1,2,3]; //1-3

var income = [1,2,3,4,5];  //1-5
var car = [1,2];  //1-2
var house = [1,2,3];  //1-2

var attributesLength = [4,2,4,5,9,3,2,3];

inp = [];
inp.push(age);
inp.push(gender);
inp.push(edu);
inp.push(income);
inp.push(job);
inp.push(census);
inp.push(car);
inp.push(house);

drawWindow2(inp, 0);

function drawWindow2(inp, judge){
    var uids = [];
	d3.selectAll("#idGrey").remove();

    d3.json("{{static_url('./json/person.json')}}", function(data){
		dataSelect = data;
        var count =0;
        var svgSelect = svg.selectAll(".one")
                  .data(dataSelect).enter()
			      .append("g")
			      .attr("id", "idGrey")
			      .attr("transform","translate(0,0)")
			      .attr("class", "content")
			      .append("circle")
			      .style("fill", function(d){
	                    var flag = true;
                        for(var i=0;i<8;i++){
                           if(inp[i].indexOf(d.attr[i])==-1){
	                           flag = false;
	                       }
                        }
                 if(flag){
                      count++;
                      uids.push(d.uid);
                      return "#ff0000";
                 }else{
                      return "#8e8e8e";
                 }
	         })
	        .attr("cx", function(d) {
		            return xScale(d.x);
	              })
	        .attr("cy", function(d) {
		            return yScale(d.y);
	              })
	         .attr("r", 2)
	         .style('opacity', 0.5)
	         .on("mouseover", function(d){
	             d3.select(this).style("stroke", "yellow");
             /*    document.getElementById("a1").innerHTML = "Age: "+d.attr[0];
                 document.getElementById("a2").innerHTML = "Gender: "+d.attr[1];
                 document.getElementById("a3").innerHTML = "Education: "+d.attr[2];
                 document.getElementById("a4").innerHTML = "Income: "+d.attr[3];
                 document.getElementById("a5").innerHTML = "Job: "+d.attr[4];
                 document.getElementById("a6").innerHTML = "Census: "+d.attr[5];
                 document.getElementById("a7").innerHTML = "Car: "+d.attr[6];
                 document.getElementById("a8").innerHTML = "House: "+d.attr[7];*/
	         })
	         .on("mouseout", function(d){
	             d3.select(this).style("stroke", "none");
	         });
	         if(judge==1){
	         	  getUID(uids);
	         }
      });
}

function getUID(uids){
      console.log("number of selected citizens ", uids.length);
      var time1 = 360;
      var time2 = 720;
      var mode = 2;
      console.log("example", uids[0]);
      getDataWindow3(uids, time1, time2, mode);
}

function getDataWindow3(uids, time1, time2, mode){
         var self = this;
         var formData = new FormData();
	     formData.append('value', uids);
	     formData.append('st', time1);
	     formData.append('et', time2);
	     formData.append('m', mode);
	     var url = 'http://localhost:30030/window3';
	     lSendUrl('POST', url, formData, drawWindow3);

         function drawWindow3(response){
              numberjson = JSON.parse(response['number']);
              clusterjson = JSON.parse(response['cluster']);
              odsum = response['sum'];

              console.log(response['number']);

              d3.json("{{static_url('./json/TAZ.geojson')}}", function(err, data){
                     mapjson = data;
                     init();
                     animate();
                     initSVGObject();
              });
         }
}

</script>

</body>

