<head>
    <script type="text/javascript" src="{{static_url('./lib/paper-full.min.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/d3.min.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/Detector.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/jquery.min.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/lurlquery.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/three.min.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/OrbitControls.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/TrackballControls.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./lib/jquery-ui.js')}}"></script>
    <link rel="stylesheet" href="{{static_url('./lib/ui.css')}}">
    <link rel="stylesheet" href="//apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">


    <script type="text/javascript" src="{{static_url('./js/window1.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./js/window2.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./js/window3.js')}}"></script>
    <script type="text/javascript" src="{{static_url('./js/window4v2.js')}}"></script>

</head>


<body>
<canvas id="canvas1" style="position: absolute;top: 0; left: 0; width: 43%;  height: 35%; background: white;"></canvas>
<canvas id="canvas3" style="position: absolute;top: 38%; left: 0; width: 43%;  height: 65%; background: none; "></canvas>
<div id='window2' style="position: absolute; width: 10%;height: 20%;top: 47%; left: 0; background:none;"></div>

<div id="window41" style="position: absolute;background-color:#eeeeee; width: 19%;height: 30%;top: 0;left: 41%; border:solid #0000FF"></div>
<div id="window42" style="position: absolute;background-color:#eeeeee; width: 19%;height: 30%;top: 0;left: 60.2%; border:solid #0000FF"></div>
<div id="window43" style="position: absolute;background-color:#eeeeee; width: 19%;height: 30%;top: 0;left: 79.4%; border:solid #0000FF"></div>
<div id="window44" style="position: absolute;background-color:#eeeeee; width: 57.4%;height: 69%;top: 30.4%;left: 41%; border:solid #0000FF"></div>

<select id="group" style ="position: absolute; top:96%; left:10%; visibility: hidden">
  <option value ="1">Group 1</option> <option value ="2">Group 2</option>
 </select>

<p id="g1name" style="position: absolute; top:37%; left:27.5%; color:grey">Group 1: name</p>
<p id="g2name" style="position: absolute; top:60.7%; left:27.5%; color:grey">Group 2: name</p>

<input id="nameInput" style="position: absolute; visibility: hidden">
<button id="nameButton" style="position: absolute; visibility: hidden">submit</button>

<canvas id="canvas5" style="position: absolute;top: 55%; left: 90%; width: 8%;  height: 40%; background-color: #eeeeee;"></canvas>

<div id="timeline" style="position: absolute; top:96%; left:47%; width:35%; clear:left;"></div>
<p style="position:absolute; top:94%; left:44%; font-size:18px; font-family:arial">TIME</p>
<input id="timeText" type="text" value="6-12" style="position: absolute; top:96%; left:83%; border:0; width:3%; font-weight:bold;">
<input id="pornot" type="checkbox" style="position: absolute; top:96%; left:87%">
<p style="position:absolute; top:95%; left:88%; font-size:18px; font-family:arial; font-size:10px">With Purpose</p>
<button id="timeSubmit" style="position: absolute; top:96%; left:93%;" onclick=show25d()>show</button>


<select id="purposeSelect" style ="position: absolute; top: 93%; left: 90%" onchange=getPurposeData()>
  <option value ="1">work</option> <option value ="2">school</option>  <option value ="3">home</option>
  <option value ="4">shopping</option>  <option value ="5">dinner/entertainment</option>
  <option value ="6">business/affair</option>  <option value ="7">visiting friends</option>
  <option value ="8">hospital</option>  <option value ="9">pick up/drop off</option>
  <option value ="10">others</option>
 </select>


<button id="ptest" style="position: absolute; top:90%; left:91%;" onclick=ptest()>PurposeTest</button>
<div id="root_chart"></div>


<script type="text/paperscript" canvas="canvas1">

		g_liAttrName = ['gender', 'age', 'income', 'edu', 'resident', 'car', 'house', 'job'];

        var age = [1,2,3,4];
        var gender = [1,2]; //1-2
        var edu = [1,2,3,4];  //1-4
        var job = [1,2,3,4,5,6,7,8,9]; //1-9
        var resident = [1,2,3]; //1-3
        var income = [1,2,3,4,5];  //1-5
        var car = [1,2];  //1-2
        var house = [1,2,3];  //1-3

        attributesLength = [4,2,4,5,9,3,2,3];
        inp = [];

        inp.push(age);
        inp.push(gender);
        inp.push(edu);
        inp.push(income);
        inp.push(job);
        inp.push(resident);
        inp.push(car);
        inp.push(house);

		// Create a Paper.js Path to draw a line into it:
		var path = new Path();
		var canvasRect = document.getElementById('canvas1').getClientRects()[0];

		// Give the stroke a color
		var centerPos = {x: canvasRect.x + canvasRect.width * 0.5,
							y: canvasRect.y + canvasRect.height * 0.5}

	 	paper.project.importSVG("{{static_url('./svg/window2.svg')}}",
        	function(item){
        		g_Root = item;
            initDecoration(item);
        		drawWindow2(inp, 0);
        		initEvent(item);
        });

</script>

<script>
	var h = 400, w = 400;
    var svg = d3.select("#window2")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .append("g")
            .attr("transform", "translate(0,0)")
            .attr("id","svgWindow2");

         svg.append("rect")
            .attr("cx", 200)
            .attr("cy", 200)
            .attr("r", 200)
            .style("fill", "#eeeeee");

var padding = 1;

var xScale, yScale;
var xAxis, yAxis;

var xScale = d3.scale.linear().domain([-78, 78]).range([padding*2, w - padding * 2]);
var yScale = d3.scale.linear().domain([-75, 75]).range([h - padding * 2, 2*padding ]);

dataPortrait = {};
dataPortraitFromW2 = {};
current = 1;

function initDecoration(item){
  console.log(' init decoration ');
  var childItem = item.children['deco_circle'];
  // childItem.strokeColor = 'black'
  setInterval(function(){ childItem.rotate(1);console("Hello"); }, 200);
  
}

function drawWindow2(inp, judge){

	d3.selectAll("#idPoint").remove();
	d3.selectAll("#idSquareSelect").remove();
	dataPortrait = {};

    d3.json("{{static_url('./json/person.json')}}", function(data){
		dataSelect = data;
        var count =0;
        var svgSelect = svg.selectAll(".one")
                  .data(dataSelect).enter()
			      .append("g")
			      .attr("id", "idPoint")
			      .attr("transform","translate(0,0)")
			      .append("circle")
			      .style("fill", function(d){
	                    var flag = true;
                        for(var i=0;i<8;i++){
                           if(inp[i].indexOf(d.attr[i])==-1){
	                           flag = false;
	                       }
                        }
                        if(flag){
                            count++;
                            if(d.attr.toString() in dataPortrait){
                                  dataPortrait[d.attr.toString()] = dataPortrait[d.attr.toString()]+1;
                            }else{
                                  dataPortrait[d.attr.toString()] = 1;
                            }
                            return "#0000ff";
                        }else{
                            return "#8e8e8e";
                        }
	              })
	              .attr("cx", function(d) {
		                return xScale(d.x);
	              })
	              .attr("cy", function(d) {
		                return yScale(d.y);
	              })
	              .attr("r", 2.5)
	              .style('opacity', 0.6)
	              .on("mouseover", function(d){
	                    d3.select(this).style("stroke", "black").style("stroke-width", 3);
	                    drawFigure(0,d.attr,1,3);
	              })
	              .on("mouseout", function(d){
	                    d3.select(this).style("stroke", "none");
	                    clearCurrentFigures(3);
	              });
        console.log("dataPortrait got. ");
        dataPortraitFromW2 = {};
        squareSelect(dataPortrait);
        if(judge!=0){
              current = 1;
              drawWindow3(dataPortrait, page);
        }
    });
}

</script>

<script type="text/paperscript" canvas="canvas3">
            groups = [0,0];
            personas13 = [[2,1,3,2,2,2,2,2], [2,2,2,1,4,2,2,2], [2,1,2,3,5,2,2,2],[2,2,3,4,4,2,2,2],[2,2,3,5,9,2,2,2],
                  [2,2,2,1,9,2,2,2],[2,1,3,1,5,2,2,2],[2,1,3,1,2,2,2,2],[2,2,3,2,4,2,2,2],[2,1,3,2,4,2,2,2],[2,1,3,2,5,2,2,2],
                  [2,1,3,1,7,2,2,2],[2,2,1,1,9,2,2,2]];
            personasNumber = [324, 269, 261, 249, 237, 232, 218, 216, 212, 192, 158, 148, 145];
            groupAttr = [[],[]];

            page = 0;
            var canvas2 = document.getElementById('canvas3');
            paper.setup(canvas2);
            var path = new paper.Path();
            paper.project.importSVG("{{static_url('./svg/103_new.svg')}}",function(item){

                  g_16Root = item;
                  g_liText = [[],[],[],[]];

                  //set basic figure invisible
                  setSuserbaseVisible(false, 5);

                  //init all buttons
                  initButtons(item);

                  //age, gender, edu, income
                  //job, resident, car ,house
                  drawFigure(1,[2,1,3,2,2,2,2,2],324,0);
                  drawFigure(2,[2,2,2,1,4,2,2,2],269,0);
                  drawFigure(3,[2,1,2,3,5,2,2,2],261,0);
                  drawFigure(4,[2,2,3,4,4,2,2,2],249,0);
                  drawFigure(5,[2,2,3,5,9,2,2,2],237,0);
                  drawFigure(6,[2,2,2,1,9,2,2,2],232,0);
                  drawFigure(7,[2,1,3,1,5,2,2,2],218,0);
                  drawFigure(8,[2,1,3,1,2,2,2,2],216,0);
                  drawFigure(9,[2,2,3,2,4,2,2,2],212,0);
                  drawFigure(10,[2,1,3,2,4,2,2,2],192,0);
                  drawFigure(11,[2,1,3,2,5,2,2,2],158,0);
                  drawFigure(12,[2,1,3,1,7,2,2,2],148,0);
                  drawFigure(13,[2,2,1,1,9,2,2,2],145,0);
                  //drawFigure(14,[2,2,2,1,5,2,2,2],145);
                  //drawFigure(15,[2,1,2,1,4,2,2,2],142);
            });



</script>
<script>

    SHIFTBAG = {
			'house': [-15, 7],
			'car': [15, 7],
			'hair': [0, -21],
			'glass': [0, -6],
			'age_1': [-5, -26],
			'age_3': [0, -23],
			'age_4': [0, -21],
			'job': [0,23],
			'job_2': [0, 21],
			'income': [13, 22],
			'resident': [-13, 25],
		}

</script>

<script>
    initTimeSlider();

     var canvas5 = document.getElementById('canvas5');
     paper.setup(canvas5);
     var path = new paper.Path();
     paper.project.importSVG("{{static_url('./svg/purpose.svg')}}",function(item){
        		g_Root10 = item;
        		initPurpose(item);
    });

	var $d3g = {};
    d3threeD( $d3g );

    var renderer, scene, camera;

    var controls, stats, positionning, raycaster;
    var mouse = new THREE.Vector2();

    var numberjson, mapjson, clusterjson;

    uids = [];

    function begintoDraw(n){
        console.log("Begin to draw......");
        console.log(groupAttr[n]);
        d3.json("{{static_url('./json/person.json')}}", function(data){
		        for(x in data){
		            for(var i=0;i<groupAttr[n].length;i++){
                         var str1 = data[x].attr.toString();
                         var str2 = groupAttr[n][i].toString();
                         if(str1==str2){
		                     uids.push(data[x].uid);
                         }
		            }
		        }
                //getDataFor41(uids); //home work distribution
                //getDataFor42(uids);
                //getDataFor43(uids);
        });
    }


function getDataFor41(uids){
         var self = this;
         var formData = new FormData();
	     formData.append('value', uids);
	     var url = 'http://localhost:30030/window4';
	     lSendUrl('POST', url, formData, drawWindow4);

         function drawWindow4(response){
              numberjson = JSON.parse(response['r1']);
              max = response['max'];

              d3.json("{{static_url('./json/TAZ.geojson')}}", function(err, data){
                     mapjson = data;
                     init41();
                     animate();
                     initSVGObject(41, uids.length, max);
              });
         }
}


function getDataFor42(uids){
         console.log("42");
         var self = this;
         var formData = new FormData();
	     formData.append('value', uids);
	     var url = 'http://localhost:30030/window4';
	     lSendUrl('POST', url, formData, drawWindow4);

         function drawWindow4(response){
              numberjson = JSON.parse(response['r2']);
              max = response['max'];

              d3.json("{{static_url('./json/TAZ.geojson')}}", function(err, data){
                     mapjson = data;
                     init42();
                     animate();
                     initSVGObject(42, uids.length, max);
              });
         }
}

function getDataFor43(uids){
         console.log("43");
         var self = this;
         var formData = new FormData();
	     formData.append('value', uids);
	     var url = 'http://localhost:30030/window43';
	     lSendUrl('POST', url, formData, drawWindow43);

         function drawWindow43(response){
              numberjson = JSON.parse(response['result']);
              max = response['max'];

              d3.json("{{static_url('./json/TAZ.geojson')}}", function(err, data){
                     mapjson = data;
                     init43();
                     animate();
                     initSVGObject(43, uids.length, max);
              });
         }
}

function show25d(){
     var out = $( "#timeText" ).val();
     var time1 = parseInt(out.split("-")[0])*60;
     var time2 = parseInt(out.split("-")[1])*60;

     var check = $("#pornot").prop('checked');
     if(check){
         //true, show P
     }else{
        getDataFor44(uids, time1, time2);
     }
}

function getDataFor44(uids, time1, time2){
         var self = this;
         var formData5 = new FormData();
	     formData5.append('value', uids);
	     formData5.append('st', time1);
	     formData5.append('et', time2);
	     var url = 'http://localhost:30030/pCluster';
	     lSendUrl('POST', url5, formData5, drawWindow44);

         function drawWindow44(response){
              numberjson = JSON.parse(response['number']);
              odsum = response['sum'];
              max = response['max'];

              d3.json("{{static_url('./json/TAZ.geojson')}}", function(err, data){
                     mapjson = data;
                     init44();
                     animate();
                     initSVGObject(5, odsum, max);
              });
         }
}


function getPurposeData(){
	var a = document.getElementById("purposeSelect");
	var p = a.options[a.selectedIndex].value;

    var out = $( "#timeText" ).val();
    var time1 = parseInt(out.split("-")[0])*60;
    var time2 = parseInt(out.split("-")[1])*60;

    var self = this;
    var formData = new FormData();
	formData.append('value', uids);
	formData.append('st', time1);
	formData.append('et', time2);
	formData.append('p', p);
	var url = 'http://localhost:30030/purpose';
	lSendUrl('POST', url, formData, drawPurpose);

    function drawPurpose(response){
           numberjson = JSON.parse(response['number']);
           odsum = response['sum'];
           max = response['max'];

           initSVGObject(7, odsum, p);
    }
}

function ptest(){
    var out = $( "#timeText" ).val();
    var time1 = parseInt(out.split("-")[0])*60;
    var time2 = parseInt(out.split("-")[1])*60;

    var self = this;
    var formData = new FormData();
	formData.append('value', uids);
	formData.append('st', time1);
	formData.append('et', time2);
	var url = 'http://localhost:30030/pCluster';
	console.log("begin to get data.");
	lSendUrl('POST', url, formData, drawPurposeCluster);

       function drawPurposeCluster(response){
           console.log("data already got.");
           numberjson = JSON.parse(response['number']);
           console.log("data length", numberjson.length);

            d3.json("{{static_url('./json/TAZ.geojson')}}", function(err, data){
                     mapjson = data;
                     init44();
                     animate();
                     initSVGObject(6, 0, 0);
            });
       }
}


</script>

</body>

